name: 'Update snap tag'
description: 'Update the snapcraft.yaml for a given snap with the latest upstream tag'

# Inputs required by the action to perform correctly.
# user: This is the user of GITHUB_TOKEN. If no user is provided, the default user is 'ubuntu'.
# token: This is the GITHUB_TOKEN that exists for the other repo whose workflow uses this action. Without the other repo's token, this action does not have permission to perform tasks on the other repo, like pushing changes or opening a PR
# repo: This is the repo who is using this action. This repo contains the snapcraft.yaml that this action will be working on.
inputs:
  user:
    description: 'The user of the GITHUB_TOKEN'
    required: false
    default: 'ubuntu'
  token:
    description: 'A Github PAT'
    required: true
  repo:
    description: 'The repo containing the snapcraft.yaml to be updated'
    required: true
    default: 'None'

# Outputs generated by running this action.
outputs:
  new-snapcraft-yaml:
    description: "Updated snapcraft.yaml"
    value: ${{ steps.updatesnapyaml.outputs.new-snapcraft-yaml }}

# Global env var that can keep track of if there was a change or not. This determines if there are commits to be pushed.
env:
  IS_CHANGE: false

# The jobs description defining a composite action
runs:
  using: "composite"

  steps:
# Step to checkout the desktop-snaps repo so that we can run updatesnapyaml.py. We need to define a folder called desktop-snaps to avoid the checkout overwriting the other repo's checkout which comes first in the other repo's workflow
    - name: checkout desktop-snaps repo
      uses: actions/checkout@v3
      with:
        repository: 'ubuntu/desktop-snaps'
        ref: stable
        path: desktop-snaps

# Step to run the script that will generate a new output_file with an updated tag, if one is available. If there was a change, then we move this to the snapcraft.yaml and note that there was a change. 
    - name: run updatesnapyaml
      id: updatesnapyaml
      run: |
        ./desktop-snaps/updatesnap/updatesnapyaml.py --github-user $GITHUB_USER --github-token $GITHUB_TOKEN https://github.com/${{ github.repository }}
        # Make sure to put the updated snapcraft.yaml file in the right location if it lives in a snap directory
        if [ -f output_file ]; then
          echo "IS_CHANGE=true" >> $GITHUB_ENV
          if [ -d snap ]; then
            mv output_file snap/snapcraft.yaml
          else
            mv output_file snapcraft.yaml
          fi
        fi
      env:
        GITHUB_USER: ${{ inputs.user || 'ubuntu' }}
        GITHUB_TOKEN: ${{ inputs.token }}
      shell: bash

# Step to remove the desktop-snaps folder so that when we commit changes in another repo, the desktop-snaps folder is not committed there.
    - name: Cleanup
      run: |
        rm -rf desktop-snaps
      shell: bash

# If there was a change detected, then let's commit the changes
    - name: Commit files
      if: ${{ env.IS_CHANGE }}
      run: |
        set -x
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -a -m "Update tag"
      shell: bash

# If there was a change detected, then let's push the changes
    - name: Push changes
      if: ${{ env.IS_CHANGE }}
      uses: ad-m/github-push-action@master
      run: |
        set -eux
        echo $GITHUB_USER
      shell: bash
      env:
        GITHUB_USER: ${{ inputs.user || 'ubuntu' }}
        GITHUB_TOKEN: ${{ inputs.token }}
      with:
        branch: ${{ github.ref }}
